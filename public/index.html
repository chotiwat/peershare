<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.min.css"/>
<script src="bower_components/jquery/dist/jquery.min.js"></script>
<script src="bower_components/socket.io-client/socket.io.js"></script>
<script src="bower_components/chance/dist/chance.min.js"></script>
<script src="js/socket.io-stream.js"></script>
</head>
<body>
<div class="container">
  <form class="form-inline">
    <div class="form-group">
      <label for="peerId">Peer Id</label>
      <input type="text" class="form-control" id="peerId"/>
    </div>
    <button type="submit" class="btn btn-default">Save</button>
  </form>
  <div class="list-group" id="fileList">
  </div>
  <input id="file" type="file" multiple/>
  <div><meter id="progress" max="1"/></div>
  <div><span id="speed"></span><span> kB/s</span></div>
</div>
<script>
var chanceOptions = {
  length: 6,
  pool: '1234567890qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM'
};
function randomId() {
  return chance.string(chanceOptions);
}

$(function() {
  var socket = io('http://localhost:7337');
  var peer = { id: randomId() };

  $('#peerId').attr('placeholder', peer.id);

  // handle connection and reconnection
  socket.on('connect', function() {
    console.log('connect');
    socket.emit('register', peer);
  });

  var files = {};
  $('#file').change(function(e) {
    var selectedFiles = e.target.files;
    for (var i = 0; i < selectedFiles.length; i++) {
      var file = selectedFiles[i];
      files[file.name] = file;
    }
    $('#fileList').empty();
    for (var fileName in files) {
      $('#fileList').append(
        $('<a/>', {
          class: 'list-group-item',
          href: '/f/' + peer.id + '/' + fileName,
          target: '_blank'
        })
        .text(fileName));
    }
  });
  
  socket.on('get-file', function(data) {
    var file = files[data.id];
    console.log(data, file);

    var stream = ss.createStream();
    ss(socket).emit('f-' + data.reqId, stream, {
      size: file.size,
      type: file.type
    });

    var end = (data.range && isFinite(data.range.end)) ? data.range.end : file.size;
    var blob = data.range ? file.slice(data.range.start, end) : file;
    var size = 0;
    console.log('%s: uploading %d bytes', data.id, blob.size);

    var t = new Date();
    var interval = setInterval(function() {
      $('#speed').text(size * 1000 / 1024 / (new Date() - t));
    }, 1000);

    socket.once('x-' + data.reqId, function() {
      console.log('%s: aborted', data.id);
      stream.end();
      clearInterval(interval);
    });

    ss.createBlobReadStream(blob)
    .on('data', function(chunk) {
      // update progress
      size += chunk.length;
      // console.log('%s: %d bytes (%d%%) uploaded', data.id, size, size / blob.size * 100);
      $('#progress').val(size / blob.size);
    })
    .on('error', function(err) {
      console.error('%s:', data.id, err);
      clearInterval(interval);
    })
    .on('close', function() {
      console.log('%s: closed', data.id);
      clearInterval(interval);
    })
    .pipe(stream);


  });
});
</script>
</body>
</html>